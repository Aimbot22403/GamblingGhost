<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ghosts Gambling</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #111;
      color: white;
      font-family: 'Segoe UI', sans-serif;
    }
    input, button, textarea, select {
      background: #222;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
      width: 100%;
    }
    button {
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #333;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    .card {
      background: #1c1c1c;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      margin-bottom: 20px;
    }
    nav {
      background: #1a1a1a;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav h1 { font-size: 20px; }
    nav .menu { cursor: pointer; }
    .tabs button {
      margin-right: 10px;
      padding: 10px 15px;
    }
    .chat {
      height: 300px;
      overflow-y: auto;
      border-radius: 10px;
      background: #181818;
      padding: 10px;
      margin-bottom: 10px;
    }
    .chat p {
      margin: 4px 0;
    }
    .online-users {
      max-height: 150px;
      overflow-y: auto;
      background: #181818;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .profile {
      text-align: center;
    }
    .profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div id="app" class="container">
  <nav>
    <h1>Ghosts Gambling</h1>
    <div class="menu" v-if="user" @click="menuOpen = !menuOpen">â˜°</div>
    <div v-if="menuOpen && user" style="position:absolute; right:20px; top:50px; background:#1a1a1a; padding:10px; border-radius:10px;">
      <button @click="tab = 'profile'">Profile</button>
      <button @click="logout">Logout</button>
    </div>
  </nav>

  <div v-if="!user" class="card">
    <h2 v-if="authMode==='login'">Login</h2>
    <h2 v-else>Register</h2>
    <input v-model="auth.username" placeholder="Username" />
    <input v-model="auth.password" type="password" placeholder="Password" />
    <button @click="authMode==='login' ? login() : register()">
      {{ authMode==='login' ? 'Login' : 'Register' }}
    </button>
    <p style="text-align:center; cursor:pointer;" @click="authMode = authMode==='login' ? 'register' : 'login'">
      Switch to {{ authMode==='login' ? 'Register' : 'Login' }}
    </p>
  </div>

  <div v-else>
    <div class="tabs card">
      <button @click="tab='home'">Home</button>
      <button @click="tab='blackjack'">Blackjack</button>
      <button @click="tab='mines'">Mines</button>
    </div>

    <div v-if="tab === 'home'" class="card">
      <h3>Welcome, {{ user.username }}</h3>
      <p>Coins: {{ user.coins }}</p>

      <div class="online-users">
        <strong>Online Users:</strong>
        <div v-for="u in onlineUsers">{{ u.username }} - {{ u.coins }}</div>
      </div>

      <div class="chat">
        <div v-for="msg in chat">
          <p><strong @click="viewProfile(msg.username)" style="cursor:pointer;">{{ msg.username }}</strong>: {{ msg.text }}</p>
        </div>
      </div>
      <input v-model="message" @keyup.enter="sendMessage" placeholder="Type your message..." />
    </div>

    <div v-if="tab === 'profile'" class="card profile">
      <h3>Your Profile</h3>
      <img :src=\"profilePic || 'https://placehold.co/100x100'\" />
      <input type=\"file\" @change=\"uploadPic\" />
      <textarea v-model=\"bio\" placeholder=\"Your bio...\"></textarea>
      <button @click=\"saveProfile\">Save</button>
    </div>

    <div v-if=\"viewedProfile\" class=\"card profile\">
      <h3>{{ viewedProfile.username }}</h3>
      <img :src=\"viewedProfile.profilePic || 'https://placehold.co/100x100'\" />
      <p>{{ viewedProfile.bio }}</p>
      <button @click=\"viewedProfile = null\">Close</button>
    </div>

    <div v-if=\"tab === 'blackjack'\" class=\"card\">
      <h3>Blackjack</h3>
      <input v-model.number=\"blackjackBet\" placeholder=\"Bet amount\" type=\"number\" />
      <button @click=\"startBlackjack\">Start</button>
      <div v-if=\"blackjackResult\">Result: {{ blackjackResult }}</div>
    </div>

    <div v-if=\"tab === 'mines'\" class=\"card\">
      <h3>Mines</h3>
      <input v-model.number=\"minesBet\" placeholder=\"Bet amount\" type=\"number\" />
      <select v-model.number=\"mineCount\">
        <option :value=\"3\">3 Mines</option>
        <option :value=\"5\">5 Mines</option>
        <option :value=\"8\">8 Mines</option>
        <option :value=\"10\">10 Mines</option>
      </select>
      <button @click=\"startMines\">Start Game</button>
      <div v-if=\"minesGrid.length\">
        <div style=\"display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:10px;\">
          <button v-for=\"(cell, i) in minesGrid\" @click=\"clickCell(i)\">
            {{ cell.revealed ? (cell.mine ? 'ðŸ’£' : 'âœ…') : '?' }}
          </button>
        </div>
      </div>
      <div v-if=\"minesResult\">Result: {{ minesResult }}</div>
    </div>
  </div>
</div>

<script>
const socket = io();
const app = Vue.createApp({
  data() {
    return {
      authMode: 'login',
      auth: { username: '', password: '' },
      user: null,
      token: '',
      menuOpen: false,
      tab: 'home',
      chat: [],
      message: '',
      onlineUsers: [],
      profilePic: '',
      bio: '',
      viewedProfile: null,
      blackjackBet: 0,
      blackjackResult: '',
      minesBet: 0,
      mineCount: 3,
      minesGrid: [],
      minesResult: ''
    };
  },
  methods: {
    async login() {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.auth)
      });
      const data = await res.json();
      if (data.token) {
        this.token = data.token;
        this.user = data.user;
        socket.emit('login', this.user.username);
        this.fetchChat();
        this.fetchUsers();
      }
    },
    async register() {
      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.auth)
      });
      const data = await res.json();
      if (data.token) {
        this.token = data.token;
        this.user = data.user;
        socket.emit('login', this.user.username);
        this.fetchChat();
        this.fetchUsers();
      }
    },
    logout() {
      this.user = null;
      this.token = '';
      this.tab = 'home';
      this.chat = [];
    },
    async fetchChat() {
      const res = await fetch('/api/chat');
      const data = await res.json();
      this.chat = data;
    },
    async fetchUsers() {
      const res = await fetch('/api/online');
      const data = await res.json();
      this.onlineUsers = data;
    },
    sendMessage() {
      if (this.message) {
        socket.emit('chat', { username: this.user.username, text: this.message });
        this.message = '';
      }
    },
    viewProfile(username) {
      fetch(`/api/user/${username}`).then(r => r.json()).then(p => this.viewedProfile = p);
    },
    uploadPic(e) {
      const reader = new FileReader();
      reader.onload = () => {
        this.profilePic = reader.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    },
    async saveProfile() {
      const res = await fetch('/api/profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.token
        },
        body: JSON.stringify({ profilePic: this.profilePic, bio: this.bio })
      });
    },
    async startBlackjack() {
      const res = await fetch('/api/blackjack', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.token
        },
        body: JSON.stringify({ bet: this.blackjackBet })
      });
      const data = await res.json();
      this.blackjackResult = data.result;
      this.user.coins = data.coins;
    },
    async startMines() {
      const res = await fetch('/api/mines/start', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.token
        },
        body: JSON.stringify({ bet: this.minesBet, mines: this.mineCount })
      });
      const data = await res.json();
      this.minesGrid = data.grid;
      this.user.coins = data.coins;
    },
    async clickCell(i) {
      const res = await fetch('/api/mines/click', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.token
        },
        body: JSON.stringify({ index: i })
      });
      const data = await res.json();
      this.minesGrid = data.grid;
      this.minesResult = data.result;
      this.user.coins = data.coins;
    }
  },
  mounted() {
    socket.on('chat', msg => this.chat.push(msg));
  }
});
app.mount('#app');
</script>
</body>
</html>
